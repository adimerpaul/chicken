import{_ as V,c as h,o as d,w as r,a as o,Q as u,e as m,b as e,aj as v,f as p,J as w,d as f,a5 as c,aa as C,t as i,a6 as b,a8 as q,a9 as Q,a7 as N,h as B}from"./index-DaLIc8C6.js";import{Q as k,b as g}from"./QList-D9l36FlJ.js";import{Q as D}from"./QBtnDropdown-BX8ZNK4a.js";import{Q as I}from"./format-CZjEqrqN.js";import{a as S,Q as F}from"./QTable-BAgSEv8T.js";import{Q as U}from"./QSpace-B6MhSPU3.js";import{Q as A}from"./QPage-BA_RSihm.js";import"./QSelect-CcbuAIQ-.js";const O={name:"ComprasIndex",data(){return{f:{ini:new Date().toISOString().substr(0,10),fin:new Date().toISOString().substr(0,10),q:""},loading:!1,rows:[],dlgVer:!1,compra:null,colsDetalles:[{name:"insumo",label:"Insumo",align:"left",field:l=>l.insumo&&l.insumo.nombre?l.insumo.nombre:""},{name:"unidad",label:"Unidad",align:"left",field:l=>l.insumo&&l.insumo.unidad?l.insumo.unidad:""},{name:"cantidad",label:"Cantidad",align:"right",field:"cantidad"},{name:"costo",label:"Costo",align:"right",field:l=>Number(l.costo||0).toFixed(2)},{name:"subtotal",label:"Subtotal",align:"right",field:l=>Number(l.subtotal||0).toFixed(2)}]}},computed:{totalCompras(){return this.rows.reduce((l,t)=>l+Number(t.total||0),0)},totalAnuladas(){return this.rows.filter(l=>l.estado==="ANULADO").reduce((l,t)=>l+Number(t.total||0),0)},totalVigentes(){return this.rows.filter(l=>l.estado!=="ANULADO").reduce((l,t)=>l+Number(t.total||0),0)}},mounted(){this.fetch()},methods:{money(l){return Number(l||0).toLocaleString("es-BO",{minimumFractionDigits:2,maximumFractionDigits:2})},async fetch(){this.loading=!0;try{const l=await this.$axios.post("compras/report",{fechaInicio:this.f.ini,fechaFin:this.f.fin,q:this.f.q});this.rows=l.data}catch(l){this.$alert&&this.$alert.error&&this.$alert.error(l.response?.data?.message||"No se pudo cargar")}finally{this.loading=!1}},async ver(l){try{const t=await this.$axios.get(`compras/${l}`);this.compra=t.data,this.dlgVer=!0}catch{this.$alert&&this.$alert.error&&this.$alert.error("No se pudo abrir la compra")}},anular(l){this.$alert.dialog("¿Anular la compra? Esto revertirá el stock.").onOk(async()=>{this.loading=!0;try{await this.$axios.put(`compras/${l}/anular`),this.$alert&&this.$alert.success&&this.$alert.success("Compra anulada"),this.fetch()}catch(t){this.$alert&&this.$alert.error&&this.$alert.error(t.response?.data?.message||"No se pudo anular")}finally{this.loading=!1}})},exportCSV(){const l=["ID","Fecha","Proveedor","Items","Total","Estado"],t=this.rows.map(a=>[a.id,a.fecha,a.proveedor||"",a.detalles_count,a.total,a.estado]),x=[l,...t].map(a=>a.join(";")).join(`
`),_=new Blob([x],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(_),n=document.createElement("a");n.href=s,n.download="compras.csv",n.click(),URL.revokeObjectURL(s)}}},L={class:"row items-end"},E={class:"col-12 col-md-3 q-pa-xs"},T={class:"col-12 col-md-3 q-pa-xs"},R={class:"col-12 col-md-3 q-pa-xs"},j={class:"col-12 col-md-3 q-pa-xs text-right"},P={class:"row q-mt-sm"},z={class:"col-xs-12 col-md-4 q-pa-xs"},J={class:"text-h6 text-weight-bold"},M={class:"col-xs-12 col-md-4 q-pa-xs"},G={class:"text-h6 text-weight-bold"},H={class:"col-xs-12 col-md-4 q-pa-xs"},K={class:"text-h6 text-weight-bold"},W={class:"row q-mt-sm"},X={class:"col-12"},Y={key:0},Z={class:"text-right"},$={class:"text-right text-bold"},ee={key:1},te={class:"text-subtitle1"},le={class:"q-mb-sm"},se={class:"text-right text-subtitle1 q-mt-sm"};function oe(l,t,x,_,s,n){return d(),h(A,{class:"q-pa-md bg-grey-3"},{default:r(()=>[o(u,null,{default:r(()=>[o(m,{class:"q-pa-sm"},{default:r(()=>[e("div",L,[e("div",E,[o(v,{modelValue:s.f.ini,"onUpdate:modelValue":t[0]||(t[0]=a=>s.f.ini=a),label:"Fecha Inicio",type:"date",outlined:"",dense:""},null,8,["modelValue"])]),e("div",T,[o(v,{modelValue:s.f.fin,"onUpdate:modelValue":t[1]||(t[1]=a=>s.f.fin=a),label:"Fecha Fin",type:"date",outlined:"",dense:""},null,8,["modelValue"])]),e("div",R,[o(v,{modelValue:s.f.q,"onUpdate:modelValue":t[2]||(t[2]=a=>s.f.q=a),label:"Buscar (proveedor / nota / estado)",outlined:"",dense:"",clearable:""},null,8,["modelValue"])]),e("div",j,[o(p,{color:"primary",label:"Nueva Compra",icon:"add_shopping_cart","no-caps":"",class:"text-bold q-mr-sm",to:{path:"/compras/insumos"}}),o(p,{color:"indigo",label:"Buscar",icon:"search","no-caps":"",class:"text-bold",loading:s.loading,onClick:n.fetch},null,8,["loading","onClick"]),o(D,{class:"q-ml-sm",color:"green",label:"Exportar","no-caps":"","auto-close":""},{default:r(()=>[w((d(),h(k,{clickable:"",onClick:n.exportCSV},{default:r(()=>[o(g,{avatar:""},{default:r(()=>[o(f,{name:"save_alt"})]),_:1}),o(g,null,{default:r(()=>[...t[5]||(t[5]=[c("CSV",-1)])]),_:1})]),_:1},8,["onClick"])),[[C]]),w((d(),h(k,{clickable:"",onClick:n.fetch},{default:r(()=>[o(g,{avatar:""},{default:r(()=>[o(f,{name:"refresh"})]),_:1}),o(g,null,{default:r(()=>[...t[6]||(t[6]=[c("Recargar",-1)])]),_:1})]),_:1},8,["onClick"])),[[C]])]),_:1})])]),e("div",P,[e("div",z,[o(u,{flat:"",bordered:""},{default:r(()=>[o(m,{class:"row items-center"},{default:r(()=>[o(f,{name:"trending_up",color:"green",size:"md",class:"q-mr-sm"}),e("div",null,[t[7]||(t[7]=e("div",{class:"text-caption"},"Compras (Bs)",-1)),e("div",J,i(n.money(n.totalCompras)),1)])]),_:1})]),_:1})]),e("div",M,[o(u,{flat:"",bordered:""},{default:r(()=>[o(m,{class:"row items-center"},{default:r(()=>[o(f,{name:"block",color:"red",size:"md",class:"q-mr-sm"}),e("div",null,[t[8]||(t[8]=e("div",{class:"text-caption"},"Anuladas (Bs)",-1)),e("div",G,i(n.money(n.totalAnuladas)),1)])]),_:1})]),_:1})]),e("div",H,[o(u,{flat:"",bordered:""},{default:r(()=>[o(m,{class:"row items-center"},{default:r(()=>[o(f,{name:"check_circle",color:"blue",size:"md",class:"q-mr-sm"}),e("div",null,[t[9]||(t[9]=e("div",{class:"text-caption"},"Vigentes (Bs)",-1)),e("div",K,i(n.money(n.totalVigentes)),1)])]),_:1})]),_:1})])]),e("div",W,[e("div",X,[o(S,{dense:"","wrap-cells":""},{default:r(()=>[t[11]||(t[11]=e("thead",{class:"bg-black text-white"},[e("tr",null,[e("th",null,"#"),e("th",null,"Fecha"),e("th",null,"Proveedor"),e("th",null,"Ítems"),e("th",null,"Total"),e("th",null,"Estado"),e("th",null,"Opciones")])],-1)),s.rows.length?(d(),b("tbody",Y,[(d(!0),b(q,null,Q(s.rows,a=>(d(),b("tr",{key:a.id},[e("td",null,i(a.id),1),e("td",null,i(a.fecha),1),e("td",null,i(a.proveedor||"—"),1),e("td",Z,i(a.detalles_count),1),e("td",$,i(n.money(a.total)),1),e("td",null,[o(I,{color:a.estado==="ANULADO"?"negative":"primary","text-color":"white",dense:""},{default:r(()=>[c(i(a.estado),1)]),_:2},1032,["color"])]),e("td",null,[o(p,{flat:"",dense:"",round:"",icon:"visibility",onClick:y=>n.ver(a.id)},null,8,["onClick"]),a.estado==="ACTIVO"?(d(),h(p,{key:0,flat:"",dense:"",round:"",icon:"block",color:"negative",onClick:y=>n.anular(a.id)},null,8,["onClick"])):N("",!0)])]))),128))])):(d(),b("tbody",ee,[...t[10]||(t[10]=[e("tr",null,[e("td",{colspan:"7",class:"text-center"},"Sin compras")],-1)])]))]),_:1})])])]),_:1})]),_:1}),o(B,{modelValue:s.dlgVer,"onUpdate:modelValue":t[4]||(t[4]=a=>s.dlgVer=a)},{default:r(()=>[o(u,{style:{"min-width":"720px"}},{default:r(()=>[o(m,{class:"row items-center q-pb-none"},{default:r(()=>[e("div",te,"Compra #"+i(s.compra?s.compra.id:""),1),o(U),o(p,{flat:"",round:"",dense:"",icon:"close",onClick:t[3]||(t[3]=a=>s.dlgVer=!1)})]),_:1}),o(m,{class:"q-pt-none"},{default:r(()=>[e("div",le,[e("div",null,[t[12]||(t[12]=e("b",null,"Fecha:",-1)),c(" "+i(s.compra?s.compra.fecha:""),1)]),e("div",null,[t[13]||(t[13]=e("b",null,"Proveedor:",-1)),c(" "+i(s.compra&&s.compra.proveedor?s.compra.proveedor:"—"),1)]),e("div",null,[t[14]||(t[14]=e("b",null,"Estado:",-1)),c(" "+i(s.compra?s.compra.estado:""),1)]),e("div",null,[t[15]||(t[15]=e("b",null,"Nota:",-1)),c(" "+i(s.compra&&s.compra.nota?s.compra.nota:"—"),1)])]),o(F,{rows:s.compra&&s.compra.detalles?s.compra.detalles:[],columns:s.colsDetalles,flat:"",bordered:"",dense:"","rows-per-page-options":[0]},null,8,["rows","columns"]),e("div",se,[t[16]||(t[16]=e("b",null,"Total:",-1)),c(" "+i(n.money(s.compra?s.compra.total:0))+" Bs ",1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const pe=V(O,[["render",oe]]);export{pe as default};
